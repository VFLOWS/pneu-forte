<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="pneu-forte-colors.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aferição de Veículos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="tailwind.config.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        /* Custom scrollbar for horizontal scrolling if needed */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Tablet-only (md..lg): sidebar recolhido (ícones) com toggle */
        @media (min-width: 768px) {
            #sidebar { transition: width 300ms ease; }
            #main-content { transition: margin-left 300ms ease; }

            body { overflow-x: hidden; }

            #sidebar nav a {
                position: relative;
                overflow: hidden;
                min-height: 44px;
            }

            #sidebar nav a i {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 1.25rem;
                flex: 0 0 1.25rem;
                line-height: 1;
            }

            #sidebar .pf-sidebar-label {
                display: inline-block;
                overflow: hidden;
                white-space: nowrap;
                max-width: 999px;
                opacity: 1;
                transform: translateX(0);
                transition: max-width 300ms ease, opacity 200ms ease, transform 200ms ease;
            }

            #sidebar .pf-sidebar-section-title {
                overflow: hidden;
                max-height: 2rem;
                opacity: 1;
                transform: translateY(0);
                transition: max-height 300ms ease, opacity 200ms ease, transform 200ms ease;
            }

            #sidebar .pf-sidebar-footer {
                overflow: hidden;
                max-height: 120px;
                opacity: 1;
                transform: translateY(0);
                transition: max-height 300ms ease, opacity 200ms ease, transform 200ms ease;
            }

            body:not(.pf-tablet-sidebar-expanded) #sidebar .pf-sidebar-label {
                max-width: 0;
                opacity: 0;
                transform: translateX(-6px);
            }

            body:not(.pf-tablet-sidebar-expanded) #sidebar .pf-sidebar-section-title {
                max-height: 0;
                opacity: 0;
                transform: translateY(-6px);
            }

            body:not(.pf-tablet-sidebar-expanded) #sidebar .pf-sidebar-footer {
                max-height: 0;
                opacity: 0;
                transform: translateY(8px);
            }

            body.pf-tablet-sidebar-expanded #sidebar { width: 20rem !important; /* w-80 */ }
            body:not(.pf-tablet-sidebar-expanded) #sidebar { width: 5rem !important; /* w-20 */ }

            #main-content { margin-left: 5rem !important; /* w-20 */ }
            body.pf-tablet-sidebar-expanded #main-content { margin-left: 20rem !important; /* w-80 */ }
        }
    </style>
</head>

<body class="bg-gray-50 font-sans">

    <header id="header"
        class="bg-white border-b border-gray-200 fixed top-0 left-0 right-0 z-50 bg-gradient-to-br from-azul-02 to-preto-90">
        <div class="flex items-center justify-between px-4 sm:px-6 py-3 h-[61px]">
            <div class="flex items-center space-x-3 sm:space-x-4 min-w-0">
                <button id="sidebar-toggle" class="text-white text-xl md:hidden focus:outline-none">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <img src="PNEU-FORTE-2.png" alt="Pneu Forte Logo" class="h-10">
                <h1 class="text-lg lg:text-2xl font-bold text-white hidden sm:block whitespace-nowrap truncate">Sistema de Aferição de Pneus</h1>
            </div>
            <div class="flex items-center space-x-6">
                <div class="relative hidden lg:block">
                    <input type="text" placeholder="Buscar aferições..."
                        class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm w-80 focus:outline-none focus:ring-2 focus:ring-azul-02 focus:border-transparent">
                    <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
                <a href="selecao-modulo.html" class="flex items-center space-x-2 text-white hover:text-gray-200 bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-lg transition-colors mr-2 hidden md:flex" title="Trocar Módulo">

                    <i class="fa-solid fa-table-cells-large"></i>

                    <span class="text-sm font-medium">Módulos</span>

                </a>

                <button class="relative p-2 text-white hover:text-gray-300">
                    <i class="fa-regular fa-bell text-xl"></i>
                    <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                </button>
                <div class="flex items-center space-x-3">
                    <img src="https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-2.jpg" alt="User"
                        class="w-9 h-9 rounded-full">
                    <div class="text-right hidden sm:block">
                        <p class="text-sm font-medium text-white">Carlos Silva</p>
                        <p class="text-xs text-white">Analista</p>
                    </div>
                    <i class="fa-solid fa-chevron-down text-white text-xs hidden sm:block"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- Overlay for mobile -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden opacity-0 transition-opacity duration-300 md:hidden" onclick="toggleSidebar()"></div>

    <aside id="sidebar" class="fixed left-0 top-[61px] h-[calc(100vh-61px)] w-64 md:w-20 bg-white border-r border-gray-200 flex flex-col transition-transform duration-300 -translate-x-full md:translate-x-0 z-40">
        <nav class="p-4 flex-1 overflow-y-auto">
            <!-- Tablet toggle (somente md..lg) -->
            <div class="pf-tablet-toggle-wrap hidden md:flex justify-end mb-3">
                <button id="tablet-sidebar-toggle" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-lg text-gray-600 hover:bg-gray-100" aria-label="Expandir/Recolher menu">
                    <i class="fa-solid fa-angles-right"></i>
                </button>
            </div>
            <div class="space-y-1">
                <a href="dashboard-frota.html" class="flex items-center px-4 py-3 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg">
                <i class="fa-solid fa-chart-line mr-3 text-base text-gray-500"></i>
                <span class="pf-sidebar-label">Dashboard de Aferição</span>
            </a>
            <a href="nova-solicitacao-frota.html" class="flex items-center px-4 py-3 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg">
                <i class="fa-solid fa-plus-circle mr-3 text-base text-gray-500"></i>
                <span class="pf-sidebar-label">Nova Aferição</span>
            </a>
            <a href="solicitacoes-frota.html" class="flex items-center px-4 py-3 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg">
                <i class="fa-solid fa-list mr-3 text-base text-gray-500"></i>
                <span class="pf-sidebar-label">Histórico de Aferições</span>
            </a>
                      <a href="aferir.html"
                    class="flex items-center px-4 py-3 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg">
                    <i class="fa-solid  fa-compact-disc mr-3 text-base text-gray-500"></i>
                    <span class="pf-sidebar-label">Solicitação de aferimento</span>
                </a>
                <a href="relatorios-frota.html" class="flex items-center px-4 py-3 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg">
                    <i class="fa-solid fa-file-chart-column mr-3 text-base text-gray-500"></i>
                    <span class="pf-sidebar-label">Relatórios</span>
                </a>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-200">
                <p class="pf-sidebar-section-title px-4 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Cadastros</p>
                <div class="space-y-1">
                    <a href="clientes-frota.html" class="flex items-center px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-100 rounded-lg">
                        <i class="fa-solid fa-users mr-3 text-gray-500"></i>
                        <span class="pf-sidebar-label">Clientes</span>
                    </a>
                    <a href="caminhoes.html" class="flex items-center px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-100 rounded-lg">
                        <i class="fa-solid fa-truck mr-3 text-gray-500"></i>
                        <span class="pf-sidebar-label">Veículos</span>
                    </a>
                    <a href="motoristas.html" class="flex items-center px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-100 rounded-lg">
                        <i class="fa-solid fa-id-card mr-3 text-gray-500"></i>
                        <span class="pf-sidebar-label">Motoristas</span>
                    </a>
                    <a href="marcas_frota.html" class="flex items-center px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-100 rounded-lg">
                        <i class="fa-solid fa-copyright mr-3 text-gray-500"></i>
                        <span class="pf-sidebar-label">Marcas de Pneu</span>
                    </a>
                    <a href="modelos_frota.html" class="flex items-center px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-100 rounded-lg">
                        <i class="fa-solid fa-car mr-3 text-gray-500"></i>
                        <span class="pf-sidebar-label">Modelos de Pneu</span>
                    </a>
                </div>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-200">
                <p class="pf-sidebar-section-title px-4 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Administração</p>
                <div class="space-y-1">
                    <a href="usuarios-frota.html" class="flex items-center px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-100 rounded-lg">
                        <i class="fa-solid fa-users mr-3 text-gray-500"></i>
                        <span class="pf-sidebar-label">Usuários</span>
                    </a>
                    <a href="#" class="flex items-center px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-100 rounded-lg">
                        <i class="fa-solid fa-gear mr-3 text-gray-500"></i>
                        <span class="pf-sidebar-label">Configurações</span>
                    </a>
                    <a href="selecao-modulo.html" class="flex items-center px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 rounded-lg mt-4">
                        <i class="fa-solid fa-arrow-left mr-3"></i>
                        <span class="pf-sidebar-label">Trocar Módulo</span>
                    </a>
                </div>
            </div>
        </nav>

        <div class="pf-sidebar-footer shrink-0 p-4 bg-gradient-to-r from-primary-700 to-primary-800 m-4 rounded-lg">
            <div class="flex items-center justify-between text-white">
                <div>
                    <p class="text-xs font-medium opacity-90">Parceiro</p>
                    <p class="text-sm font-bold">Grupo Vipal</p>
                </div>
                <i class="fa-solid fa-handshake text-2xl opacity-80"></i>
            </div>
        </div>
    </aside>

    <main id="main-content" class="ml-0 md:ml-20 lg:ml-64 mt-[61px] p-3 sm:p-6 transition-all duration-300">
        <div class="mb-6">
            <a href="aferir.html" class="text-sm text-primary-700 hover:text-primary-800 flex items-center mb-2">
                <i class="fa-solid fa-arrow-left mr-2"></i>
                Voltar para Aferição
            </a>
            <h2 class="text-lg sm:text-2xl font-bold text-gray-800">Aferição de Frota #AFER-2026-001</h2>
            <p class="text-sm text-gray-600 mt-1">Cliente: <span class="font-bold text-gray-800">Transportadora
                    Veloz</span></p>
        </div>

        <div class="bg-white rounded-lg border border-gray-200 p-4 sm:p-6 mb-6">
            <div class="flex flex-col lg:flex-row lg:justify-between lg:items-start gap-4">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">Informações da Aferição</h3>
                    <div class="mt-4 space-y-2 text-sm text-gray-600">
                        <p><strong class="font-medium text-gray-800">Data Início:</strong> 26/01/2026</p>
                        <p><strong class="font-medium text-gray-800">Status:</strong> <span
                                class="px-2.5 py-1 text-xs font-medium bg-blue-100 text-blue-700 rounded-full">Em
                                Andamento</span></p>
                        <p><strong class="font-medium text-gray-800">Veículos Aferidos:</strong> <span
                                id="total-veiculos">0</span></p>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 w-full lg:w-auto">
                    <button onclick="window.location.href='afericao-analise-detalhe.html'"
                        class="w-full sm:w-auto px-4 py-2.5 bg-azul-02 text-white rounded-lg hover:bg-azul-04 flex items-center justify-center font-medium transition-colors text-sm">
                        <i class="fa-solid fa-chart-simple mr-2"></i>
                        Ver Resultado
                    </button>
                    <button type="button" onclick="saveAnalysis()"
                        class="w-full sm:w-auto px-4 py-2.5 bg-white text-azul-02 border border-azul-02 rounded-lg hover:bg-blue-50 flex items-center justify-center font-medium transition-colors text-sm">
                        <i class="fa-regular fa-floppy-disk mr-2"></i>
                        Salvar Aferição
                    </button>
                    <button type="button" onclick="window.location.href='afericao-analise-detalhe.html'"
                        class="w-full sm:w-auto px-4 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center font-medium transition-colors text-sm">
                        <i class="fa-solid fa-check mr-2"></i>
                        Concluir Aferição
                    </button>
                </div>
            </div>
        </div>

        <div id="inspection-header" class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div>
                <h3 class="text-lg sm:text-xl font-bold text-gray-800">Aferição de Veículo</h3>
                <p class="text-xs sm:text-sm text-gray-500">Realize a aferição detalhada do veículo.</p>
            </div>
        </div>



        <!-- Lista de Veículos -->
        <div id="vehicles-list" class="space-y-6">
            <!-- Cards de veículos serão inseridos aqui via JS -->
        </div>

        <!-- Resultado da Inspeção (Dashboard) -->
        <div id="inspection-results" class="hidden space-y-6">
            <!-- KPIs -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6">
                <div class="bg-white p-3 sm:p-5 rounded-lg border border-gray-200">
                    <h3 class="text-xs sm:text-sm font-medium text-gray-500">Total de Veículos Aferidos</h3>
                    <p class="text-2xl sm:text-3xl font-bold text-gray-800 mt-2">1</p>
                </div>
                <div class="bg-white p-3 sm:p-5 rounded-lg border border-gray-200">
                    <h3 class="text-xs sm:text-sm font-medium text-gray-500">Total de Pneus Analisados</h3>
                    <p class="text-2xl sm:text-3xl font-bold text-gray-800 mt-2">10</p>
                </div>
                <div class="bg-white p-3 sm:p-5 rounded-lg border border-gray-200">
                    <h3 class="text-xs sm:text-sm font-medium text-gray-500">Pneus com Perda de Sulco</h3>
                    <p class="text-2xl sm:text-3xl font-bold text-red-600 mt-2">0</p>
                    <p class="text-xs text-gray-500 mt-1">0% do total analisado</p>
                </div>
                <div class="bg-white p-3 sm:p-5 rounded-lg border border-gray-200">
                    <h3 class="text-xs sm:text-sm font-medium text-gray-500">Fora da Faixa de Pressão</h3>
                    <p class="text-2xl sm:text-3xl font-bold text-orange-500 mt-2">20%</p>
                    <p class="text-xs text-gray-500 mt-1">2 pneus afetados</p>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-6">
                <div class="bg-white p-4 sm:p-6 rounded-lg border border-gray-200">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-3 sm:mb-4">Estimativa de Vida Útil (Sulco)</h3>
                    <div id="chart-position" class="w-full h-72"></div>
                </div>
                <div class="bg-white p-4 sm:p-6 rounded-lg border border-gray-200">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-3 sm:mb-4">Distribuição de Pressão dos Pneus</h3>
                    <div id="chart-pressure" class="w-full h-72"></div>
                </div>
            </div>

            <!-- Trend Chart -->
            <div class="grid grid-cols-1 gap-3 sm:gap-6">
                <div class="bg-white p-4 sm:p-6 rounded-lg border border-gray-200">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 sm:gap-4 mb-4">
                        <h3 class="text-base sm:text-lg font-semibold text-gray-800">Tendência de Qualidade da Pressão</h3>
                        <div class="flex flex-wrap items-center gap-3 text-xs">
                            <span class="flex items-center"><span class="w-3 h-3 bg-green-500 rounded-full mr-1"></span> Correta</span>
                            <span class="flex items-center"><span class="w-3 h-3 bg-red-500 rounded-full mr-1"></span> Baixa</span>
                            <span class="flex items-center"><span class="w-3 h-3 bg-yellow-500 rounded-full mr-1"></span> Alta</span>
                        </div>
                    </div>
                    <div id="chart-trend" class="w-full h-80"></div>
                </div>
            </div>
        </div>

    </main>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirmation-modal" class="fixed inset-0 z-[1100] hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeDeleteModal()"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fa-solid fa-triangle-exclamation text-red-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Remover Veículo</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500">Tem certeza que deseja remover este veículo da inspeção? Esta ação não pode ser desfeita.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="confirmDeleteVehicle()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Remover
                    </button>
                    <button type="button" onclick="closeDeleteModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-azul-02 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tire Detail Modal (Mobile/Tablet UX) -->
    <div id="tire-detail-modal" class="fixed inset-0 z-[1200] hidden overflow-y-auto" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-black/50 z-0" aria-hidden="true" onclick="closeTireModal()"></div>
        <div class="min-h-screen flex items-center justify-center px-4 py-6 relative z-10">
            <div class="bg-white rounded-lg w-full max-w-lg shadow-xl max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between p-4 sm:p-5 border-b border-gray-200">
                    <div class="min-w-0">
                        <p id="tire-modal-subtitle" class="text-xs text-gray-500 truncate">Editar pneu</p>
                        <h3 id="tire-modal-title" class="text-lg font-bold text-gray-800">Pneu</h3>
                    </div>
                    <button type="button" onclick="closeTireModal()" class="text-gray-400 hover:text-gray-600 p-2" title="Fechar">
                        <i class="fa-solid fa-times text-lg"></i>
                    </button>
                </div>

                <div class="p-4 sm:p-5 space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sulco (mm)</label>
                            <input id="tire-modal-mm" type="number" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-azul-02" placeholder="mm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Marca / Modelo</label>
                            <select id="tire-modal-brand" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-azul-02 bg-white"></select>
                        </div>
                    </div>

                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <label class="block text-sm font-medium text-gray-700">PSI</label>
                            <span id="prolog-conn-pill" class="px-2 py-0.5 rounded-full text-[11px] font-extrabold border border-gray-200 bg-gray-100 text-gray-700">Sem conexão</span>
                        </div>
                        <div class="flex items-stretch gap-2">
                            <input id="tire-modal-psi" type="number" class="flex-1 w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-azul-02" placeholder="PSI">
                            <button id="prolog-connect-btn" type="button" onclick="connectPrologMock()"
                                class="inline-flex items-center justify-center gap-2 px-4 rounded-lg bg-gradient-to-br from-azul-02 to-preto-90 text-white font-extrabold text-sm hover:from-azul-04 hover:to-preto-90 shadow-sm whitespace-nowrap">
                                <i class="fa-solid fa-plug"></i>
                                Conectar Aferidor
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Condição</label>
                        <div class="grid grid-cols-3 gap-2">
                            <label class="cursor-pointer">
                                <input type="radio" name="tire-modal-status" value="ok" class="sr-only peer">
                                <div class="w-full px-3 py-2 rounded-lg border border-gray-200 text-center text-sm font-semibold bg-white text-gray-700 hover:bg-gray-50 peer-checked:border-green-600 peer-checked:bg-green-600 peer-checked:text-white">
                                    <i class="fa-solid fa-check mr-1"></i> Ok
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="tire-modal-status" value="attention" class="sr-only peer">
                                <div class="w-full px-3 py-2 rounded-lg border border-gray-200 text-center text-sm font-semibold bg-white text-gray-700 hover:bg-gray-50 peer-checked:border-yellow-500 peer-checked:bg-yellow-500 peer-checked:text-white">
                                    <i class="fa-solid fa-exclamation mr-1"></i> Atenção
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="tire-modal-status" value="remove" class="sr-only peer">
                                <div class="w-full px-3 py-2 rounded-lg border border-gray-200 text-center text-sm font-semibold bg-white text-gray-700 hover:bg-gray-50 peer-checked:border-red-600 peer-checked:bg-red-600 peer-checked:text-white">
                                    <i class="fa-solid fa-xmark mr-1"></i> Troca
                                </div>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Observação do pneu (opcional)</label>
                        <textarea id="tire-modal-obs" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-azul-02" placeholder="Ex: desgaste irregular, calibragem, etc."></textarea>
                    </div>
                </div>

                <div class="p-4 sm:p-5 border-t border-gray-200 flex flex-col sm:flex-row gap-2 sm:justify-end">
                    <button type="button" onclick="closeTireModal()" class="w-full sm:w-auto px-4 py-2.5 bg-white text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium text-sm">Cancelar</button>
                    <button type="button" onclick="saveTireModal()" class="w-full sm:w-auto px-4 py-2.5 bg-azul-02 text-white rounded-lg hover:bg-azul-04 font-medium text-sm">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="vehicle-safety-checklist-modal" class="fixed inset-0 z-[1250] hidden overflow-y-auto" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-black/50 z-0" aria-hidden="true" onclick="closeVehicleSafetyChecklistModal()"></div>
        <div class="min-h-screen flex items-center justify-center px-4 py-6 relative z-10">
            <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl max-h-[90vh] overflow-y-auto flex flex-col">
                <div class="flex items-center justify-between p-6 border-b border-gray-100">
                    <div class="min-w-0 flex-1">
                        <p id="vehicle-safety-checklist-subtitle" class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Checklist de segurança</p>
                        <h3 id="vehicle-safety-checklist-title" class="text-lg font-bold text-gray-800 truncate">Veículo</h3>
                    </div>
                    <button type="button" onclick="closeVehicleSafetyChecklistModal()" class="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition-colors" title="Fechar">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>

                <div class="p-6 flex-1 overflow-y-auto">
                    <div class="flex items-center justify-between gap-4 mb-6">
                        <div class="flex-1">
                             <div class="flex justify-between items-end mb-2">
                                <span class="text-xs font-bold text-azul-02 uppercase tracking-wider">Progresso</span>
                                <span id="vehicle-safety-checklist-progress" class="text-xs font-bold text-gray-500">0/0</span>
                            </div>
                            <div class="h-2 w-full bg-gray-100 rounded-full overflow-hidden">
                                <div id="vehicle-safety-checklist-bar" class="h-full bg-azul-02 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col items-center text-center">
                        <div class="w-full aspect-video bg-gray-50 rounded-xl border border-gray-100 mb-6 overflow-hidden relative group">
                             <img id="vehicle-safety-checklist-illustration" class="w-full h-full object-cover" alt="Ilustração do item" src="">
                             <div class="absolute inset-0 bg-black/5 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                <i class="fa-solid fa-magnifying-glass-plus text-white/80 text-3xl drop-shadow-lg"></i>
                             </div>
                        </div>
                        
                        <h4 id="vehicle-safety-checklist-item-title" class="text-2xl font-extrabold text-gray-900 mb-8">—</h4>

                        <div class="grid grid-cols-2 gap-4 w-full">
                            <button id="vehicle-safety-checklist-status-problem" type="button" onclick="openVehicleSafetyChecklistProblemModal()" class="flex flex-col items-center justify-center gap-2 p-4 rounded-xl border-2 border-gray-200 bg-white text-gray-600 hover:border-red-200 hover:bg-red-50 hover:text-red-600 transition-all group">
                                <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-red-100 transition-colors">
                                    <i class="fa-solid fa-triangle-exclamation text-lg"></i>
                                </div>
                                <span class="font-bold text-sm">Com problema</span>
                            </button>

                            <button id="vehicle-safety-checklist-status-ok" type="button" onclick="setVehicleSafetyChecklistStatus('ok')" class="flex flex-col items-center justify-center gap-2 p-4 rounded-xl border-2 border-gray-200 bg-white text-gray-600 hover:border-green-200 hover:bg-green-50 hover:text-green-600 transition-all group">
                                <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-green-100 transition-colors">
                                    <i class="fa-solid fa-check text-lg"></i>
                                </div>
                                <span class="font-bold text-sm">Tudo certo</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="p-6 border-t border-gray-100 flex items-center justify-between gap-3 bg-gray-50/50 rounded-b-2xl">
                    <button id="vehicle-safety-checklist-prev" type="button" onclick="prevVehicleSafetyChecklistStep()" class="px-6 py-3 bg-white text-gray-600 border border-gray-200 rounded-xl hover:bg-gray-50 font-bold text-sm transition-all shadow-sm">
                        Voltar
                    </button>
                    <button id="vehicle-safety-checklist-next" type="button" onclick="nextVehicleSafetyChecklistStep()" class="flex-1 px-6 py-3 bg-azul-02 text-white rounded-xl hover:bg-azul-04 font-extrabold text-sm shadow-md shadow-blue-500/20 transition-all transform active:scale-95">
                        Próximo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Problema -->
    <div id="vehicle-safety-checklist-problem-modal" class="fixed inset-0 z-[1300] hidden overflow-y-auto" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-0" aria-hidden="true"></div>
        <div class="min-h-screen flex items-center justify-center px-4 py-6 relative z-10">
            <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden animate-fade-in-up">
                <div class="bg-red-50 p-6 border-b border-red-100 flex items-start gap-4">
                     <div class="shrink-0 w-10 h-10 rounded-full bg-red-100 flex items-center justify-center text-red-600">
                        <i class="fa-solid fa-triangle-exclamation text-lg"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-red-900">Relatar Problema</h3>
                        <p id="problem-modal-item-title" class="text-sm text-red-700 mt-1">Item: —</p>
                    </div>
                    <button type="button" onclick="closeVehicleSafetyChecklistProblemModal()" class="text-red-400 hover:text-red-600">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase tracking-wider mb-2">Título do problema</label>
                        <input type="text" id="problem-title" class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-red-500/20 focus:border-red-500 transition-all" placeholder="Ex: Lanterna quebrada">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase tracking-wider mb-2">Descrição detalhada</label>
                        <textarea id="problem-description" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-red-500/20 focus:border-red-500 transition-all resize-none" placeholder="Descreva o problema em detalhes..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase tracking-wider mb-3">Prioridade</label>
                        <div class="grid grid-cols-3 gap-3">
                            <label class="cursor-pointer">
                                <input type="radio" name="problem-priority" value="critica" class="peer sr-only">
                                <div class="text-center py-2 px-3 rounded-lg border border-gray-200 bg-white text-gray-600 text-sm font-medium peer-checked:bg-red-600 peer-checked:text-white peer-checked:border-red-600 transition-all hover:bg-gray-50">
                                    Crítica
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="problem-priority" value="alta" class="peer sr-only">
                                <div class="text-center py-2 px-3 rounded-lg border border-gray-200 bg-white text-gray-600 text-sm font-medium peer-checked:bg-orange-500 peer-checked:text-white peer-checked:border-orange-500 transition-all hover:bg-gray-50">
                                    Alta
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="problem-priority" value="baixa" class="peer sr-only" checked>
                                <div class="text-center py-2 px-3 rounded-lg border border-gray-200 bg-white text-gray-600 text-sm font-medium peer-checked:bg-yellow-500 peer-checked:text-white peer-checked:border-yellow-500 transition-all hover:bg-gray-50">
                                    Baixa
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase tracking-wider mb-2">Foto do problema</label>
                        <button type="button" onclick="document.getElementById('problem-photo-input').click()" class="flex items-center justify-center gap-2 text-sm font-medium text-azul-02 hover:text-azul-04 transition-colors py-3 px-4 rounded-xl hover:bg-azul-50 w-full border border-dashed border-azul-02/30 bg-blue-50/30">
                            <i class="fa-solid fa-camera"></i>
                            Adicionar evidência
                        </button>
                        <input id="problem-photo-input" type="file" accept="image/*" class="sr-only" onchange="handleProblemPhotoSelect(this)">
                        
                        <div id="problem-photo-preview" class="mt-3 hidden bg-gray-50 rounded-lg p-3 border border-gray-200 flex items-center gap-3">
                            <img id="problem-photo-thumb" class="h-12 w-12 rounded-lg object-cover bg-gray-200 border border-gray-300" src="">
                            <div class="flex-1 min-w-0">
                                <p class="text-xs font-bold text-gray-700 mb-0.5">Foto anexada</p>
                                <p id="problem-photo-name" class="text-[10px] text-gray-500 truncate">imagem.jpg</p>
                            </div>
                            <button type="button" onclick="removeProblemPhoto()" class="text-gray-400 hover:text-red-500 transition-colors p-2 hover:bg-red-50 rounded-full">
                                <i class="fa-solid fa-trash text-sm"></i>
                            </button>
                        </div>
                    </div>
                    
                     <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase tracking-wider mb-2">Responsável (Opcional)</label>
                        <input type="text" id="problem-responsible" class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-red-500/20 focus:border-red-500 transition-all" placeholder="Nome do responsável">
                    </div>
                </div>
                
                <div class="p-6 border-t border-gray-100 bg-gray-50 flex gap-3">
                    <button type="button" onclick="closeVehicleSafetyChecklistProblemModal()" class="flex-1 px-4 py-3 bg-white text-gray-700 border border-gray-200 rounded-xl font-bold text-sm hover:bg-gray-50 transition-all">
                        Cancelar
                    </button>
                    <button type="button" onclick="saveProblemDetails()" class="flex-1 px-4 py-3 bg-red-600 text-white rounded-xl font-bold text-sm hover:bg-red-700 shadow-lg shadow-red-600/20 transition-all transform active:scale-95">
                        Salvar Problema
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let vehiclesData = [];
        const PF_VEHICLES_STORAGE_KEY = 'pf_prolog_prototipo_vehicles_v1';

        function serializeVehiclesDataForStorage(data) {
            return (data || []).map(v => ({
                id: v.id,
                placa: v.placa,
                frota: v.frota,
                modelo: v.modelo,
                marca: v.marca,
                cor: v.cor,
                combustivel: v.combustivel,
                config: v.config,
                km: v.km,
                ano: v.ano,
                detalhes: v.detalhes,
                tires: (v.tires || []).map(t => ({
                    pos: t.pos,
                    brand: t.brand,
                    psi: t.psi,
                    mm: t.mm,
                    status: t.status,
                    obs: t.obs,
                    prologConnected: !!t.prologConnected
                })),
                vehicleSafetyChecklist: {
                    items: Object.fromEntries(vehicleSafetyChecklistSteps.map(step => {
                        const item = v.vehicleSafetyChecklist?.items?.[step.id] || {};
                        const status = item.status !== undefined ? item.status : (item.ok ? 'ok' : null);
                        return [step.id, { 
                            status, 
                            note: item.note || '', 
                            fileName: item.fileName || '', 
                            photoUrl: item.photoUrl || null,
                            problemDetails: item.problemDetails || null 
                        }];
                    }))
                }
            }));
        }

        function persistVehiclesData() {
            try {
                const payload = serializeVehiclesDataForStorage(vehiclesData);
                localStorage.setItem(PF_VEHICLES_STORAGE_KEY, JSON.stringify(payload));
            } catch (e) {
            }
        }

        function loadVehiclesDataFromStorage() {
            try {
                const raw = localStorage.getItem(PF_VEHICLES_STORAGE_KEY);
                if (!raw) return false;
                const parsed = JSON.parse(raw);
                if (!Array.isArray(parsed)) return false;
                vehiclesData = parsed;
                return true;
            } catch (e) {
                return false;
            }
        }

        // Template para pneus baseados na configuração (simplificado) - mantido para dados mockados
        const tirePositions = {
            '4x2': ['1E', '1D', '2EE', '2EI', '2DI', '2DD'],
            '6x2': ['1E', '1D', '2EE', '2EI', '2DI', '2DD', '3EE', '3EI', '3DI', '3DD'], // Eixo de apoio
            '6x4': ['1E', '1D', '2EE', '2EI', '2DI', '2DD', '3EE', '3EI', '3DI', '3DD'],
            '8x2': ['1E', '1D', '2E', '2D', '3EE', '3EI', '3DI', '3DD', '4EE', '4EI', '4DI', '4DD'], 
            'carreta-1': ['1EE', '1EI', '1DI', '1DD'],
            'carreta-2': ['1EE', '1EI', '1DI', '1DD', '2EE', '2EI', '2DI', '2DD'],
            'carreta-3': ['1EE', '1EI', '1DI', '1DD', '2EE', '2EI', '2DI', '2DD', '3EE', '3EI', '3DI', '3DD'],
            'carreta-4': ['1EE', '1EI', '1DI', '1DD', '2EE', '2EI', '2DI', '2DD', '3EE', '3EI', '3DI', '3DD', '4EE', '4EI', '4DI', '4DD']
        };

        const tireBrands = [
            {value: 'michelin', label: 'Michelin'},
            {value: 'bridgestone', label: 'Bridgestone'},
            {value: 'goodyear', label: 'Goodyear'},
            {value: 'pirelli', label: 'Pirelli'},
            {value: 'continental', label: 'Continental'},
            {value: 'dunlop', label: 'Dunlop'},
            {value: 'firestone', label: 'Firestone'},
            {value: 'fate', label: 'Fate'},
            {value: 'maggion', label: 'Maggion'},
            {value: 'outros', label: 'Outros / Mistas'}
        ];

        const vehicleSafetyChecklistSteps = [
            { id: 'farois', label: 'Faróis (alto e baixo)', icon: 'fa-car-side', img: 'farois.png' },
            { id: 'lanternas', label: 'Lanternas traseiras', icon: 'fa-lightbulb', img: 'lanterna_traseira.png' },
            { id: 'luz_freio', label: 'Luz de freio', icon: 'fa-circle-dot', img: 'luz_freio.png' },
            { id: 'luz_re', label: 'Luz de ré', icon: 'fa-truck-fast', img: 'luz_re.png' },
            { id: 'setas', label: 'Setas (dianteira e traseira)', icon: 'fa-right-left', img: 'setas.png' },
            { id: 'extintor', label: 'Extintor', icon: 'fa-fire-extinguisher', img: 'extintor.png' },
            { id: 'avarias', label: 'Registro de avarias', icon: 'fa-camera', img: 'avarias.png' }
        ];

        function getVehicleSafetyChecklistIllustrationDataUri(stepId) {
            const step = vehicleSafetyChecklistSteps.find(s => s.id === stepId);
            return step ? step.img : '';
        }

        function escapeHtml(value) {
            return String(value ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function createDefaultVehicleSafetyChecklist() {
            const items = Object.fromEntries(vehicleSafetyChecklistSteps.map(s => [s.id, { status: null, note: '', photoUrl: null, fileName: '' }]));
            return { items };
        }

        function getVehicleSafetyChecklistProgress(vehicle) {
            const state = vehicle?.vehicleSafetyChecklist?.items || {};
            const total = vehicleSafetyChecklistSteps.length;
            const done = vehicleSafetyChecklistSteps.reduce((acc, s) => acc + (state[s.id]?.status ? 1 : 0), 0);
            return { done, total };
        }

        let activeVehicleSafetyChecklistVehicleId = null;
        let activeVehicleSafetyChecklistIndex = 0;

        function openVehicleSafetyChecklistModal(vehicleId) {
            activeVehicleSafetyChecklistVehicleId = vehicleId;
            activeVehicleSafetyChecklistIndex = 0;
            renderVehicleSafetyChecklistModal();
            document.getElementById('vehicle-safety-checklist-modal').classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        function closeVehicleSafetyChecklistModal() {
            document.getElementById('vehicle-safety-checklist-modal').classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            activeVehicleSafetyChecklistVehicleId = null;
            activeVehicleSafetyChecklistIndex = 0;
        }

        function getActiveVehicleSafetyChecklist() {
            const v = vehiclesData.find(vv => vv.id === activeVehicleSafetyChecklistVehicleId);
            if (!v) return null;
            if (!v.vehicleSafetyChecklist) v.vehicleSafetyChecklist = createDefaultVehicleSafetyChecklist();
            for (const step of vehicleSafetyChecklistSteps) {
                const item = v.vehicleSafetyChecklist.items?.[step.id];
                if (!item) continue;
                if (item.status === undefined && typeof item.ok === 'boolean') item.status = item.ok ? 'ok' : null;
                if (item.note === undefined) item.note = '';
                if (item.fileName === undefined) item.fileName = item.photoUrl ? 'foto' : '';
            }
            return v;
        }

        function renderVehicleSafetyChecklistModal() {
            const v = getActiveVehicleSafetyChecklist();
            if (!v) return;

            const step = vehicleSafetyChecklistSteps[activeVehicleSafetyChecklistIndex];
            if (!v.vehicleSafetyChecklist.items[step.id]) v.vehicleSafetyChecklist.items[step.id] = { status: null, note: '', photoUrl: null, fileName: '', problemDetails: null };
            const state = v.vehicleSafetyChecklist.items[step.id];
            const progress = getVehicleSafetyChecklistProgress(v);

            document.getElementById('vehicle-safety-checklist-subtitle').textContent = `${v.placa} • ${v.modelo || ''}`.trim();
            document.getElementById('vehicle-safety-checklist-title').textContent = 'Checklist do caminhão';
            document.getElementById('vehicle-safety-checklist-progress').textContent = `${progress.done}/${progress.total} • Item ${activeVehicleSafetyChecklistIndex + 1}/${progress.total}`;

            const bar = document.getElementById('vehicle-safety-checklist-bar');
            const percent = progress.total ? Math.round(((activeVehicleSafetyChecklistIndex + 1) / progress.total) * 100) : 0;
            bar.style.width = `${percent}%`;

            const illustration = document.getElementById('vehicle-safety-checklist-illustration');
            if (illustration) illustration.src = getVehicleSafetyChecklistIllustrationDataUri(step.id);

            document.getElementById('vehicle-safety-checklist-item-title').textContent = step.label;
            const okBtn = document.getElementById('vehicle-safety-checklist-status-ok');
            const problemBtn = document.getElementById('vehicle-safety-checklist-status-problem');
            
            // Reset buttons
            okBtn.className = 'flex flex-col items-center justify-center gap-2 p-4 rounded-xl border-2 border-gray-200 bg-white text-gray-600 hover:border-green-200 hover:bg-green-50 hover:text-green-600 transition-all group';
            okBtn.querySelector('div').className = 'w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-green-100 transition-colors';
            
            problemBtn.className = 'flex flex-col items-center justify-center gap-2 p-4 rounded-xl border-2 border-gray-200 bg-white text-gray-600 hover:border-red-200 hover:bg-red-50 hover:text-red-600 transition-all group';
            problemBtn.querySelector('div').className = 'w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-red-100 transition-colors';

            if (state.status === 'ok') {
                okBtn.className = 'flex flex-col items-center justify-center gap-2 p-4 rounded-xl border-2 border-green-500 bg-green-50 text-green-700 transition-all group ring-2 ring-green-100';
                okBtn.querySelector('div').className = 'w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600';
            } else if (state.status === 'problem') {
                problemBtn.className = 'flex flex-col items-center justify-center gap-2 p-4 rounded-xl border-2 border-red-500 bg-red-50 text-red-700 transition-all group ring-2 ring-red-100';
                problemBtn.querySelector('div').className = 'w-10 h-10 rounded-full bg-red-100 flex items-center justify-center text-red-600';
            }

            const prevBtn = document.getElementById('vehicle-safety-checklist-prev');
            prevBtn.disabled = activeVehicleSafetyChecklistIndex === 0;
            prevBtn.classList.toggle('opacity-50', prevBtn.disabled);
            prevBtn.classList.toggle('cursor-not-allowed', prevBtn.disabled);

            const nextBtn = document.getElementById('vehicle-safety-checklist-next');
            nextBtn.textContent = activeVehicleSafetyChecklistIndex >= vehicleSafetyChecklistSteps.length - 1 ? 'Concluir' : 'Próximo';
        }

        function setVehicleSafetyChecklistStatus(status) {
            const v = getActiveVehicleSafetyChecklist();
            if (!v) return;
            const step = vehicleSafetyChecklistSteps[activeVehicleSafetyChecklistIndex];
            
            if (status === 'problem') {
                // Should use openVehicleSafetyChecklistProblemModal instead
                return; 
            }
            
            v.vehicleSafetyChecklist.items[step.id].status = status;
            v.vehicleSafetyChecklist.items[step.id].note = '';
            v.vehicleSafetyChecklist.items[step.id].problemDetails = null;
            
            persistVehiclesData();
            renderVehicleSafetyChecklistModal();
            
            // Auto-advance if marking as OK (optional, good UX)
            if (status === 'ok') {
                setTimeout(() => {
                    nextVehicleSafetyChecklistStep();
                }, 300);
            }
        }

        let tempProblemPhoto = { url: null, fileName: '' };

        function openVehicleSafetyChecklistProblemModal() {
            const v = getActiveVehicleSafetyChecklist();
            if (!v) return;
            const step = vehicleSafetyChecklistSteps[activeVehicleSafetyChecklistIndex];
            const item = v.vehicleSafetyChecklist.items[step.id];
            
            document.getElementById('problem-modal-item-title').textContent = `Item: ${step.label}`;
            
            // Pre-fill if exists
            const details = item.problemDetails || {};
            document.getElementById('problem-title').value = details.title || step.label; 
            document.getElementById('problem-description').value = details.description || '';
            document.getElementById('problem-responsible').value = details.responsible || '';
            
            const priority = details.priority || 'baixa';
            const radio = document.querySelector(`input[name="problem-priority"][value="${priority}"]`);
            if(radio) radio.checked = true;

            // Init Photo
            tempProblemPhoto = { url: item.photoUrl, fileName: item.fileName };
            renderProblemPhotoPreview();

            document.getElementById('vehicle-safety-checklist-problem-modal').classList.remove('hidden');
        }

        function renderProblemPhotoPreview() {
            const preview = document.getElementById('problem-photo-preview');
            const thumb = document.getElementById('problem-photo-thumb');
            const name = document.getElementById('problem-photo-name');
            const input = document.getElementById('problem-photo-input');

            if (tempProblemPhoto.url) {
                thumb.src = tempProblemPhoto.url;
                name.textContent = tempProblemPhoto.fileName || 'Imagem anexada';
                preview.classList.remove('hidden');
            } else {
                preview.classList.add('hidden');
                thumb.src = '';
                input.value = ''; 
            }
        }

        function handleProblemPhotoSelect(input) {
            const file = input?.files?.[0];
            if (!file) return;

            tempProblemPhoto = {
                url: URL.createObjectURL(file),
                fileName: file.name
            };
            renderProblemPhotoPreview();
        }

        function removeProblemPhoto() {
            tempProblemPhoto = { url: null, fileName: '' };
            renderProblemPhotoPreview();
        }

        function closeVehicleSafetyChecklistProblemModal() {
            document.getElementById('vehicle-safety-checklist-problem-modal').classList.add('hidden');
            tempProblemPhoto = { url: null, fileName: '' };
        }

        function saveProblemDetails() {
            const v = getActiveVehicleSafetyChecklist();
            if (!v) return;
            const step = vehicleSafetyChecklistSteps[activeVehicleSafetyChecklistIndex];
            
            const title = document.getElementById('problem-title').value;
            const description = document.getElementById('problem-description').value;
            const responsible = document.getElementById('problem-responsible').value;
            const priorityInput = document.querySelector('input[name="problem-priority"]:checked');
            const priority = priorityInput ? priorityInput.value : 'baixa';
            
            if (!title) {
                alert('Informe um título para o problema.');
                return;
            }

            v.vehicleSafetyChecklist.items[step.id].status = 'problem';
            v.vehicleSafetyChecklist.items[step.id].problemDetails = {
                title,
                description,
                priority,
                responsible,
                date: new Date().toISOString()
            };
            v.vehicleSafetyChecklist.items[step.id].note = description; 
            
            // Save photo
            v.vehicleSafetyChecklist.items[step.id].photoUrl = tempProblemPhoto.url;
            v.vehicleSafetyChecklist.items[step.id].fileName = tempProblemPhoto.fileName;

            persistVehiclesData();
            closeVehicleSafetyChecklistProblemModal();
            renderVehicleSafetyChecklistModal();
            
            // Auto advance
            setTimeout(() => {
                nextVehicleSafetyChecklistStep();
            }, 300);
        }

        function setVehicleSafetyChecklistNote(note) {
            // Deprecated/Unused in new UI but kept for safety
            const v = getActiveVehicleSafetyChecklist();
            if (!v) return;
            const step = vehicleSafetyChecklistSteps[activeVehicleSafetyChecklistIndex];
            v.vehicleSafetyChecklist.items[step.id].note = String(note || '').slice(0, 400);
            persistVehiclesData();
        }

        function prevVehicleSafetyChecklistStep() {
            if (activeVehicleSafetyChecklistIndex <= 0) return;
            activeVehicleSafetyChecklistIndex -= 1;
            renderVehicleSafetyChecklistModal();
        }

        function nextVehicleSafetyChecklistStep() {
            const v = getActiveVehicleSafetyChecklist();
            if (!v) return;

            if (activeVehicleSafetyChecklistIndex >= vehicleSafetyChecklistSteps.length - 1) {
                const progress = getVehicleSafetyChecklistProgress(v);
                if (progress.done === progress.total) showToast('Checklist completo', 'success');
                else showToast('Checklist salvo', 'info');
                renderVehicles(v.id);
                closeVehicleSafetyChecklistModal();
                return;
            }

            activeVehicleSafetyChecklistIndex += 1;
            renderVehicleSafetyChecklistModal();
        }

        function getBrandOptionsHtml() {
            return `<option value="">Selecione...</option>` + 
                   tireBrands.map(b => `<option value="${b.value}">${b.label}</option>`).join('');
        }

        function toggleVehicleForm(showNotification = true) {
            const modal = document.getElementById('vehicle-form-container');
            const wasHidden = modal.classList.contains('hidden');
            modal.classList.toggle('hidden');
            
            if (showNotification) {
                if (wasHidden) {
                    // showToast('Abrindo formulário de veículo', 'info'); // Opcional, pode ser removido se for verboso demais
                } else {
                    showToast('Adição de veículo cancelada', 'info');
                }
            }
        }

        function checkNewVehicle(select) {
            const newFields = document.getElementById('new-vehicle-fields');
            const genericKmDiv = document.getElementById('input-km').parentElement;

            if (select.value === 'new') {
                newFields.classList.remove('hidden');
                if(genericKmDiv) genericKmDiv.classList.add('hidden');
                updateVehicleFields('add');
            } else {
                newFields.classList.add('hidden');
                if(genericKmDiv) genericKmDiv.classList.remove('hidden');
            }
        }

        function renderAxle(axleNumber, tireCount, prefix, labelSuffix = '') {
            let html = `<div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-3">
                            <h5 class="text-xs font-bold text-gray-700 uppercase mb-2">Eixo ${axleNumber} ${labelSuffix}</h5>
                            <div class="grid grid-cols-2 gap-2">`;
            
            const options = getBrandOptionsHtml();
            
            if (tireCount === 2) {
                html += `
                    <div><label class="text-[10px] text-gray-500">Esq.</label><select name="${prefix}_e${axleNumber}_esq" class="w-full text-sm border-gray-300 rounded focus:ring-azul-02 bg-white px-2 py-1">${options}</select></div>
                    <div><label class="text-[10px] text-gray-500">Dir.</label><select name="${prefix}_e${axleNumber}_dir" class="w-full text-sm border-gray-300 rounded focus:ring-azul-02 bg-white px-2 py-1">${options}</select></div>
                `;
            } else if (tireCount === 4) {
                 html += `
                    <div><label class="text-[10px] text-gray-500">Ext. Esq.</label><select name="${prefix}_e${axleNumber}_ext_esq" class="w-full text-sm border-gray-300 rounded focus:ring-azul-02 bg-white px-2 py-1">${options}</select></div>
                    <div><label class="text-[10px] text-gray-500">Int. Esq.</label><select name="${prefix}_e${axleNumber}_int_esq" class="w-full text-sm border-gray-300 rounded focus:ring-azul-02 bg-white px-2 py-1">${options}</select></div>
                    <div><label class="text-[10px] text-gray-500">Int. Dir.</label><select name="${prefix}_e${axleNumber}_int_dir" class="w-full text-sm border-gray-300 rounded focus:ring-azul-02 bg-white px-2 py-1">${options}</select></div>
                    <div><label class="text-[10px] text-gray-500">Ext. Dir.</label><select name="${prefix}_e${axleNumber}_ext_dir" class="w-full text-sm border-gray-300 rounded focus:ring-azul-02 bg-white px-2 py-1">${options}</select></div>
                `;
            }
            
            html += `</div></div>`;
            return html;
        }

        function updateTireLayout(modalType) {
            const container = document.getElementById(modalType + '-tires-container');
            if(!container) return;

            const radios = document.getElementsByName('tipo_veiculo_' + modalType);
            let selectedType = 'caminhao';
            for (const radio of radios) { if (radio.checked) selectedType = radio.value; }

            let html = '<div class="border-t border-gray-200 pt-4 mt-2"><h4 class="text-sm font-bold text-gray-800 uppercase tracking-wider mb-4">Configuração de Pneus</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4">';

            if (selectedType === 'caminhao') {
                const axleConfig = document.getElementById(modalType + '-truck-axles').value;
                if (axleConfig === '4x2') {
                    html += renderAxle(1, 2, 'truck', '(Dianteiro)');
                    html += renderAxle(2, 4, 'truck', '(Tração)');
                } else if (axleConfig === '6x2' || axleConfig === '6x4') {
                    html += renderAxle(1, 2, 'truck', '(Dianteiro)');
                    html += renderAxle(2, 4, 'truck', '(Tração)');
                    html += renderAxle(3, 4, 'truck', '(Truck/Tração)');
                } else if (axleConfig === '8x2') {
                    html += renderAxle(1, 2, 'truck', '(Dianteiro 1)');
                    html += renderAxle(2, 2, 'truck', '(Dianteiro 2)');
                    html += renderAxle(3, 4, 'truck', '(Tração)');
                    html += renderAxle(4, 4, 'truck', '(Truck)');
                }

                const hasTrailer = document.getElementById(modalType + '-has-trailer').checked;
                if (hasTrailer) {
                    const trailerAxles = document.getElementById(modalType + '-trailer-axles').value;
                    const count = parseInt(trailerAxles) || 0;
                    for(let i=1; i<=count; i++) {
                        html += renderAxle(i, 4, 'linked_trailer', `(Carreta - Eixo ${i})`);
                    }
                }

            } else if (selectedType === 'carreta') {
                const trailerAxles = document.getElementById(modalType + '-trailer-axles').value;
                const count = parseInt(trailerAxles) || 0;
                for(let i=1; i<=count; i++) {
                    html += renderAxle(i, 4, 'trailer', `(Eixo ${i})`);
                }
            } else {
                html += renderAxle(1, 2, 'car', '(Dianteiro)');
                html += renderAxle(2, 2, 'car', '(Traseiro)');
            }

            html += '</div></div>';
            container.innerHTML = html;
        }

        function updateVehicleFields(modalType) {
            const radios = document.getElementsByName('tipo_veiculo_' + modalType);
            let selectedType = 'caminhao';
            for (const radio of radios) {
                if (radio.checked) {
                    selectedType = radio.value;
                    break;
                }
            }

            const motorFields = document.querySelectorAll(`.field-group-motor[data-group="${modalType}"]`);
            const truckFields = document.querySelector(`.field-group-truck[data-group="${modalType}"]`);
            const trailerFields = document.querySelector(`.field-group-trailer[data-group="${modalType}"]`);
            
            motorFields.forEach(el => el.classList.remove('hidden'));
            if(truckFields) truckFields.classList.add('hidden');
            if(trailerFields) trailerFields.classList.add('hidden');

            if (selectedType === 'caminhao') {
                if(truckFields) truckFields.classList.remove('hidden');
                toggleLinkedTrailer(modalType); 
            } else if (selectedType === 'carreta') {
                motorFields.forEach(el => el.classList.add('hidden')); 
                if(trailerFields) {
                    trailerFields.classList.remove('hidden');
                    const linkedOnly = trailerFields.querySelectorAll('.linked-trailer-only');
                    linkedOnly.forEach(el => el.classList.add('hidden')); 
                }
            } else if (selectedType === 'carro' || selectedType === 'van') {
                // Default visibility
            }
            
            updateTireLayout(modalType);
        }

        function toggleLinkedTrailer(modalType) {
            const checkbox = document.getElementById(modalType + '-has-trailer');
            const trailerSection = document.getElementById(modalType + '-trailer-section');
            
            if (checkbox && checkbox.checked) {
                if(trailerSection) {
                    trailerSection.classList.remove('hidden');
                    const linkedOnly = trailerSection.querySelectorAll('.linked-trailer-only');
                    linkedOnly.forEach(el => el.classList.remove('hidden'));
                }
            } else {
                const radios = document.getElementsByName('tipo_veiculo_' + modalType);
                let selectedType = '';
                for (const radio of radios) { if (radio.checked) selectedType = radio.value; }
                
                if (selectedType === 'caminhao' && trailerSection) {
                    trailerSection.classList.add('hidden');
                }
            }
            updateTireLayout(modalType);
        }

        function getTiresFromForm(containerId) {
            const container = document.getElementById(containerId);
            const selects = container.querySelectorAll('select');
            let tires = [];
            
            selects.forEach(select => {
                const name = select.name;
                const brand = select.value;
                
                let posCode = '';
                const match = name.match(/_e(\d+)_(.+)/);
                if (match) {
                    const axle = match[1];
                    const suffix = match[2];
                    
                    let posSuffix = '';
                    if (suffix === 'esq') posSuffix = 'E';
                    else if (suffix === 'dir') posSuffix = 'D';
                    else if (suffix === 'ext_esq') posSuffix = 'EE';
                    else if (suffix === 'int_esq') posSuffix = 'EI';
                    else if (suffix === 'int_dir') posSuffix = 'DI';
                    else if (suffix === 'ext_dir') posSuffix = 'DD';
                    
                    // Prefix logic
                    if(name.startsWith('linked_trailer_')) {
                         posCode = 'C-' + axle + posSuffix;
                    } else {
                         posCode = axle + posSuffix;
                    }
                }
                
                tires.push({
                    pos: posCode,
                    brand: brand,
                    psi: '',
                    mm: '',
                    status: 'ok',
                    obs: ''
                });
            });
            
            return tires;
        }

        function addVehicle() {
            const select = document.getElementById('select-veiculo');
            
            let vehicle = {};

            if (select.value === 'new') {
                const placa = document.getElementById('add-placa').value;
                const frota = document.getElementById('add-frota').value;
                const marca = document.getElementById('add-marca').value;
                const modelo = document.getElementById('add-modelo').value;
                const cor = document.getElementById('add-cor').value;
                const combustivel = document.getElementById('add-combustivel').value;
                const km = document.getElementById('add-km').value;
                const detalhes = document.getElementById('add-detalhes').value;
                const fotoInput = document.getElementById('add-foto');
                
                if (!placa) { alert('Digite a placa'); return; }

                // Get Config Description
                const radios = document.getElementsByName('tipo_veiculo_add');
                let selectedType = 'caminhao';
                for (const radio of radios) { if (radio.checked) selectedType = radio.value; }
                
                let configDesc = '';
                if(selectedType === 'caminhao') {
                    configDesc = document.getElementById('add-truck-axles').value;
                    if(document.getElementById('add-has-trailer').checked) {
                        const tAxles = document.getElementById('add-trailer-axles').value;
                        configDesc += ' + Carreta ' + tAxles + 'E';
                    }
                } else if(selectedType === 'carreta') {
                    const tAxles = document.getElementById('add-trailer-axles').value;
                    const body = document.getElementById('add-trailer-body').value;
                    configDesc = 'Carreta ' + tAxles + 'E (' + body + ')';
                } else {
                    configDesc = selectedType === 'carro' ? 'Carro' : 'Van';
                }

                const tires = getTiresFromForm('add-tires-container');

                vehicle = {
                    id: Date.now(),
                    placa: placa,
                    frota: frota,
                    modelo: modelo || 'Novo Veículo',
                    marca: marca,
                    cor: cor,
                    combustivel: combustivel,
                    config: configDesc,
                    km: km,
                    ano: '', 
                    detalhes: detalhes,
                    foto: fotoInput && fotoInput.files.length > 0 ? URL.createObjectURL(fotoInput.files[0]) : null,
                    tires: tires,
                    vehicleSafetyChecklist: createDefaultVehicleSafetyChecklist()
                };
                
            } else if (select.value) {
                const genericKm = document.getElementById('input-km').value;
                const text = select.options[select.selectedIndex].text;
                const parts = text.split(' - ');
                const placa = parts[0];
                const modelo = parts[1];
                let config = '6x2';
                let tires = generateTires('6x2');
                
                if (modelo.includes('6x4')) { config = '6x4'; tires = generateTires('6x4'); }
                if (modelo.includes('Carreta')) {
                    config = '3eixos'; 
                    tires = generateTires('carreta-3');
                }

                vehicle = {
                    id: Date.now(),
                    placa: placa,
                    modelo: modelo,
                    config: config,
                    km: genericKm,
                    tires: tires,
                    vehicleSafetyChecklist: createDefaultVehicleSafetyChecklist()
                };
            } else {
                alert('Selecione um veículo');
                return;
            }

            vehiclesData.push(vehicle);
            persistVehiclesData();
            renderVehicles(vehicle.id);
            toggleVehicleForm(false);
            showToast('Veículo adicionado', 'success');
            
            // Reset
            select.value = '';
            document.getElementById('input-km').value = '';
            document.getElementById('new-vehicle-fields').classList.add('hidden');
            const genericKmDiv = document.getElementById('input-km').parentElement;
            if(genericKmDiv) genericKmDiv.classList.remove('hidden');
        }

        function generateTires(config, isTrailer = false) {
            const positions = tirePositions[config] || tirePositions['4x2'];
            return positions.map(pos => ({
                pos: (isTrailer ? 'C-' : '') + pos,
                brand: '',
                psi: '',
                mm: '',
                status: 'ok', 
                obs: ''
            }));
        }

        function renderVehicles(expandId = null) {
            const params = new URLSearchParams(window.location.search);
            const targetId = params.get('id');
            const vehicleId = targetId ? parseInt(targetId) : (expandId || (vehiclesData.length > 0 ? vehiclesData[0].id : null));

            const container = document.getElementById('vehicles-list');
            const totalEl = document.getElementById('total-veiculos');
            container.innerHTML = '';
            
            // Filter to only show the target vehicle if ID is present
            const vehiclesToRender = vehicleId ? vehiclesData.filter(v => v.id === vehicleId) : [];
            totalEl.textContent = vehiclesToRender.length;

            if (vehiclesToRender.length === 0) {
                container.innerHTML = '<div class="p-8 text-center text-gray-500">Veículo não encontrado ou nenhum veículo selecionado. <a href="aferir.html" class="text-azul-02 hover:underline">Voltar para lista</a></div>';
                return;
            }

            vehiclesToRender.forEach((v, vIndex) => {
                // Always expanded since it's a dedicated page
                const isExpanded = true; 
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg border border-gray-200 overflow-hidden shadow-sm';

                let headerHtml = `
                <div class="bg-gray-50 px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3">
                    <div class="flex items-center space-x-3 sm:space-x-4 min-w-0 sm:flex-1">
                        <div class="bg-blue-100 p-2 rounded-lg text-azul-02 shrink-0">
                            <i class="fa-solid fa-truck text-lg sm:text-xl"></i>
                        </div>
                        <div class="min-w-0">
                            <h4 class="text-base sm:text-lg font-bold text-gray-800 break-words">${v.placa}</h4>
                            <p class="text-xs sm:text-sm text-gray-500 sm:truncate">${v.modelo} • KM: ${v.km || 'N/I'}</p>
                        </div>
                    </div>
                    <div class="w-full sm:w-auto flex items-start justify-between sm:items-center sm:justify-end gap-3 sm:gap-6 shrink-0">
                        <div class="grid grid-cols-2 gap-3 sm:flex sm:items-center sm:gap-6 flex-1 sm:flex-none">
                            <div class="text-left sm:text-right">
                                <span class="block text-[11px] sm:text-xs text-gray-500 uppercase">Pneus</span>
                                <span class="block text-sm sm:text-base font-bold text-gray-800">${v.tires.length} Unidades</span>
                            </div>
                            <div class="text-left sm:text-right">
                                <span class="block text-[11px] sm:text-xs text-gray-500 uppercase">Status</span>
                                 <span class="block text-sm sm:text-base font-bold text-green-600">Em Aferição</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 shrink-0">
                            <a href="aferir.html" class="text-gray-400 hover:text-azul-02 transition-colors p-2" title="Voltar">
                                <i class="fa-solid fa-arrow-left"></i> Voltar
                            </a>
                        </div>
                    </div>
                </div>
            `;

                const brandOptions = getBrandOptionsHtml();
                if (!v.vehicleSafetyChecklist) v.vehicleSafetyChecklist = createDefaultVehicleSafetyChecklist();
                for (const step of vehicleSafetyChecklistSteps) {
                    const item = v.vehicleSafetyChecklist.items?.[step.id];
                    if (!item) continue;
                    if (item.status === undefined && typeof item.ok === 'boolean') item.status = item.ok ? 'ok' : null;
                    if (item.note === undefined) item.note = '';
                    if (item.fileName === undefined) item.fileName = item.photoUrl ? 'foto' : '';
                }
                const checklistProgress = getVehicleSafetyChecklistProgress(v);
                const checklistProblems = vehicleSafetyChecklistSteps.filter(s => v.vehicleSafetyChecklist.items?.[s.id]?.status === 'problem');
                const checklistPillClass = checklistProblems.length > 0
                    ? 'bg-red-600 text-white border-red-700'
                    : checklistProgress.done === checklistProgress.total
                        ? 'bg-green-600 text-white border-green-700'
                        : checklistProgress.done > 0
                            ? 'bg-blue-50 text-blue-800 border-blue-200'
                            : 'bg-gray-100 text-gray-700 border-gray-200';
                const nextMissing = vehicleSafetyChecklistSteps.find(s => !v.vehicleSafetyChecklist.items?.[s.id]?.status)?.label || null;
                const checklistCtaLabel = checklistProgress.done === checklistProgress.total
                    ? 'Revisar checklist'
                    : checklistProgress.done > 0
                        ? 'Continuar checklist'
                        : 'Começar checklist';
                const checklistProblemsHtml = `
                    <div class="h-full rounded-xl border border-gray-200 bg-gray-50 p-4 flex flex-col" onclick="event.stopPropagation()">
                        <div class="flex items-start justify-between gap-3 mb-3">
                            <div class="min-w-0">
                                <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Itens com problema</p>
                                <p class="text-sm font-extrabold text-gray-900">${checklistProblems.length ? 'Revisar antes de liberar' : 'Nenhum problema registrado'}</p>
                            </div>
                            <div class="shrink-0">
                                <span class="inline-flex items-center px-2.5 py-1 rounded-full border ${checklistProblems.length ? 'border-red-700 bg-red-600 text-white' : 'border-gray-200 bg-gray-100 text-gray-500'} text-xs font-extrabold">
                                    ${checklistProblems.length}
                                </span>
                            </div>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto pr-1 space-y-2 custom-scrollbar" style="max-height: 200px;">
                            ${checklistProblems.length > 0 ? checklistProblems.map(s => {
                                const item = v.vehicleSafetyChecklist.items?.[s.id] || {};
                                const details = item.problemDetails || {};
                                const note = escapeHtml(item.note || '');
                                
                                // Priority Styles
                                const priorityMap = {
                                    critica: { label: 'Crítica', cls: 'bg-red-100 text-red-700 border-red-200' },
                                    alta: { label: 'Alta', cls: 'bg-orange-100 text-orange-700 border-orange-200' },
                                    baixa: { label: 'Baixa', cls: 'bg-yellow-100 text-yellow-800 border-yellow-200' }
                                };
                                const priority = priorityMap[details.priority] || priorityMap.baixa;
                                
                                // Date formatting
                                const dateStr = details.date ? new Date(details.date).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '--:--';

                                return `
                                <div class="flex gap-3 bg-white border border-gray-200 rounded-lg p-3 hover:border-red-300 transition-colors shadow-sm">
                                    <img src="${getVehicleSafetyChecklistIllustrationDataUri(s.id)}" class="h-12 w-12 rounded-lg border border-gray-200 bg-gray-50 object-cover shrink-0" alt="">
                                    <div class="min-w-0 flex-1">
                                        <div class="flex justify-between items-start">
                                            <h6 class="text-sm font-bold text-gray-900 leading-tight">${escapeHtml(details.title || s.label)}</h6>
                                            <span class="text-[10px] font-bold px-1.5 py-0.5 rounded border ${priority.cls}">${priority.label}</span>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1 line-clamp-2">${escapeHtml(details.description || note || 'Sem descrição')}</p>
                                        <div class="flex items-center gap-2 mt-2 text-[10px] text-gray-500">
                                            <span class="flex items-center gap-1"><i class="fa-regular fa-clock"></i> ${dateStr}</span>
                                            ${details.responsible ? `<span class="flex items-center gap-1 border-l border-gray-300 pl-2"><i class="fa-regular fa-user"></i> ${escapeHtml(details.responsible)}</span>` : ''}
                                        </div>
                                    </div>
                                </div>`;
                            }).join('') : `
                                <div class="h-full flex flex-col items-center justify-center text-center p-4 text-gray-400">
                                    <i class="fa-regular fa-circle-check text-3xl mb-2 opacity-50"></i>
                                    <p class="text-sm">Checklist ${checklistProgress.done > 0 ? 'em andamento' : 'não iniciado'}</p>
                                    <p class="text-xs opacity-75">Nenhum problema reportado até o momento.</p>
                                </div>
                            `}
                        </div>
                    </div>`;

                let bodyHtml = `
                <div id="details-${v.id}" class="${isExpanded ? '' : 'hidden'} border-t border-gray-100 bg-white">
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 bg-gray-50 p-4 rounded-lg">
                            <div>
                                <span class="block text-xs text-gray-500 uppercase">Configuração</span>
                                <span class="font-medium text-gray-800">${v.config}</span>
                            </div>
                            <div>
                                <span class="block text-xs text-gray-500 uppercase">Ano / Detalhes</span>
                                <span class="font-medium text-gray-800">${v.ano || '-'} ${v.detalhes ? ' - ' + v.detalhes : ''}</span>
                            </div>
                             <div>
                                <span class="block text-xs text-gray-500 uppercase">Carroceria</span>
                                <span class="font-medium text-gray-800 uppercase">${v.tipoCarreta || '-'}</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                            <!-- Coluna Esquerda: Resumo / Ação -->
                            <div class="rounded-xl border border-gray-200 bg-gradient-to-br from-white to-blue-50 p-4 flex flex-col justify-between" onclick="event.stopPropagation()">
                                <div>
                                    <div class="flex items-start justify-between gap-3 mb-2">
                                        <div class="min-w-0">
                                            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Checklist do caminhão</p>
                                            <p class="text-base font-extrabold text-gray-900">Segurança e conformidade</p>
                                        </div>
                                        <div class="shrink-0 text-right">
                                            <span class="inline-flex items-center px-2.5 py-1 rounded-full border text-xs font-bold ${checklistPillClass}">
                                                ${checklistProgress.done}/${checklistProgress.total}
                                            </span>
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 mb-4">${nextMissing ? `Próximo: ${nextMissing}` : (checklistProblems.length ? 'Há itens com problema.' : 'Tudo conferido.')}</p>
                                </div>
                                <button type="button" onclick="event.stopPropagation(); openVehicleSafetyChecklistModal(${v.id})" class="w-full px-4 py-3 bg-azul-02 text-white rounded-lg hover:bg-azul-04 font-extrabold text-sm shadow-sm flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-clipboard-check"></i>
                                    ${checklistCtaLabel}
                                </button>
                            </div>

                            <!-- Coluna Direita: Problemas (Sempre visível) -->
                            ${checklistProblemsHtml}
                        </div>
                        
                        <div class="mb-4 flex items-center space-x-3 bg-blue-50 p-3 rounded-lg border border-blue-100">
                            <span class="text-sm font-medium text-blue-800">Aplicar Marca a Todos:</span>
                            <select onchange="applyBrandToAll(${vIndex}, this.value)" class="px-3 py-1.5 border border-blue-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white text-gray-700">
                                ${brandOptions}
                            </select>
                        </div>

                        <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                            <!-- Lado Esquerdo -->
                            <div>
                                <h5 class="text-sm font-bold text-gray-700 mb-3 border-b pb-2 flex items-center">
                                    <i class="fa-solid fa-arrow-left mr-2 text-azul-02"></i> Lado Esquerdo
                                </h5>
                                <div class="lg:hidden">
                                    <p class="text-xs text-gray-500 mb-3">Toque em um pneu para editar.</p>
                                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                        ${v.tires.map((tire, tIndex) => {
                                            if (!tire.pos.includes('E')) return '';
                                            const brandLabel = tireBrands.find(b => b.value === tire.brand)?.label || 'Sem marca';
                                            const hasInfo = !!(tire.brand || tire.psi || tire.mm || tire.obs || (tire.status && tire.status !== 'ok'));
                                            const statusCls = !hasInfo
                                                ? 'border-gray-200 bg-gray-50 hover:bg-white'
                                                : tire.status === 'remove'
                                                    ? 'border-red-600 bg-red-600 hover:bg-red-700'
                                                    : tire.status === 'attention'
                                                        ? 'border-yellow-500 bg-yellow-500 hover:bg-yellow-600'
                                                        : 'border-green-600 bg-green-600 hover:bg-green-700';
                                            const titleCls = hasInfo ? 'text-white' : 'text-gray-800';
                                            const subCls = hasInfo ? 'text-white/90' : 'text-gray-600';
                                            const iconCls = hasInfo ? 'text-white/80' : 'text-gray-400';
                                            return `
                                            <button type="button" onclick="openTireModal(${vIndex}, ${tIndex})" class="text-left p-2 rounded-lg border ${statusCls} transition-colors">
                                                <div class="flex items-center justify-between">
                                                    <span class="text-xs font-bold ${titleCls}">${tire.pos}</span>
                                                    <i class="fa-solid fa-pen-to-square ${iconCls} text-xs"></i>
                                                </div>
                                                <p class="text-[11px] ${subCls} truncate mt-1">${brandLabel}</p>
                                                <p class="text-[11px] ${subCls} mt-0.5">PSI: <span class="font-semibold ${titleCls}">${tire.psi || '-'}</span> • Sulco: <span class="font-semibold ${titleCls}">${tire.mm || '-'}</span></p>
                                            </button>`;
                                        }).join('')}
                                    </div>
                                </div>

                                <div class="hidden lg:block overflow-x-auto">
                                    <table class="w-full text-sm text-left text-gray-500">
                                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                            <tr>
                                                <th class="px-2 py-2 text-center w-12">Pos</th>
                                                <th class="px-2 py-2">Marca/Modelo</th>
                                                <th class="px-2 py-2 text-center w-20">PSI</th>
                                                <th class="px-2 py-2 text-center w-20">Sulco</th>
                                                <th class="px-2 py-2 text-center w-24">Condição</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${v.tires.map((tire, tIndex) => {
                                                if (!tire.pos.includes('E')) return '';
                                                const currentBrandOptions = tireBrands.map(b => `<option value="${b.value}" ${tire.brand === b.value ? 'selected' : ''}>${b.label}</option>`).join('');
                                                return `
                                                <tr class="border-b hover:bg-gray-50">
                                                    <td class="px-2 py-2 font-bold text-gray-800 text-center">${tire.pos}</td>
                                                    <td class="px-2 py-2">
                                                        <select onchange="updateTire(${vIndex}, ${tIndex}, 'brand', this.value)" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:border-azul-02 bg-white">
                                                            <option value="">Selecione...</option>
                                                            ${currentBrandOptions}
                                                        </select>
                                                    </td>
                                                    <td class="px-2 py-2">
                                                        <input type="number" value="${tire.psi}" onchange="updateTire(${vIndex}, ${tIndex}, 'psi', this.value)" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:border-azul-02 text-center" placeholder="PSI">
                                                    </td>
                                                    <td class="px-2 py-2">
                                                        <input type="number" step="0.1" value="${tire.mm}" onchange="updateTire(${vIndex}, ${tIndex}, 'mm', this.value)" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:border-azul-02 text-center" placeholder="mm">
                                                    </td>
                                                    <td class="px-2 py-2">
                                                        <div class="flex space-x-1 justify-center">
                                                            <label class="inline-flex items-center cursor-pointer" title="Ok">
                                                                <input type="radio" name="status-${v.id}-${tIndex}" value="ok" ${tire.status === 'ok' ? 'checked' : ''} onchange="updateTire(${vIndex}, ${tIndex}, 'status', 'ok')" class="sr-only peer">
                                                                <div class="w-6 h-6 rounded-full bg-gray-100 peer-checked:bg-green-500 hover:bg-green-200 flex items-center justify-center transition-colors text-gray-400 peer-checked:text-white">
                                                                    <i class="fa-solid fa-check text-[10px]"></i>
                                                                </div>
                                                            </label>
                                                            <label class="inline-flex items-center cursor-pointer" title="Atenção">
                                                                <input type="radio" name="status-${v.id}-${tIndex}" value="attention" ${tire.status === 'attention' ? 'checked' : ''} onchange="updateTire(${vIndex}, ${tIndex}, 'status', 'attention')" class="sr-only peer">
                                                                <div class="w-6 h-6 rounded-full bg-gray-100 peer-checked:bg-yellow-400 hover:bg-yellow-200 flex items-center justify-center transition-colors text-gray-400 peer-checked:text-white">
                                                                    <i class="fa-solid fa-exclamation text-[10px]"></i>
                                                                </div>
                                                            </label>
                                                            <label class="inline-flex items-center cursor-pointer" title="Troca">
                                                                <input type="radio" name="status-${v.id}-${tIndex}" value="remove" ${tire.status === 'remove' ? 'checked' : ''} onchange="updateTire(${vIndex}, ${tIndex}, 'status', 'remove')" class="sr-only peer">
                                                                <div class="w-6 h-6 rounded-full bg-gray-100 peer-checked:bg-red-500 hover:bg-red-200 flex items-center justify-center transition-colors text-gray-400 peer-checked:text-white">
                                                                    <i class="fa-solid fa-xmark text-[10px]"></i>
                                                                </div>
                                                            </label>
                                                        </div>
                                                    </td>
                                                </tr>`;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Lado Direito -->
                            <div>
                                <h5 class="text-sm font-bold text-gray-700 mb-3 border-b pb-2 flex items-center justify-end">
                                    Lado Direito <i class="fa-solid fa-arrow-right ml-2 text-azul-02"></i>
                                </h5>
                                <div class="lg:hidden">
                                    <p class="text-xs text-gray-500 mb-3">Toque em um pneu para editar.</p>
                                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                        ${v.tires.map((tire, tIndex) => {
                                            if (tire.pos.includes('E')) return '';
                                            const brandLabel = tireBrands.find(b => b.value === tire.brand)?.label || 'Sem marca';
                                            const hasInfo = !!(tire.brand || tire.psi || tire.mm || tire.obs || (tire.status && tire.status !== 'ok'));
                                            const statusCls = !hasInfo
                                                ? 'border-gray-200 bg-gray-50 hover:bg-white'
                                                : tire.status === 'remove'
                                                    ? 'border-red-600 bg-red-600 hover:bg-red-700'
                                                    : tire.status === 'attention'
                                                        ? 'border-yellow-500 bg-yellow-500 hover:bg-yellow-600'
                                                        : 'border-green-600 bg-green-600 hover:bg-green-700';
                                            const titleCls = hasInfo ? 'text-white' : 'text-gray-800';
                                            const subCls = hasInfo ? 'text-white/90' : 'text-gray-600';
                                            const iconCls = hasInfo ? 'text-white/80' : 'text-gray-400';
                                            return `
                                            <button type="button" onclick="openTireModal(${vIndex}, ${tIndex})" class="text-left p-2 rounded-lg border ${statusCls} transition-colors">
                                                <div class="flex items-center justify-between">
                                                    <span class="text-xs font-bold ${titleCls}">${tire.pos}</span>
                                                    <i class="fa-solid fa-pen-to-square ${iconCls} text-xs"></i>
                                                </div>
                                                <p class="text-[11px] ${subCls} truncate mt-1">${brandLabel}</p>
                                                <p class="text-[11px] ${subCls} mt-0.5">PSI: <span class="font-semibold ${titleCls}">${tire.psi || '-'}</span> • Sulco: <span class="font-semibold ${titleCls}">${tire.mm || '-'}</span></p>
                                            </button>`;
                                        }).join('')}
                                    </div>
                                </div>

                                <div class="hidden lg:block overflow-x-auto">
                                    <table class="w-full text-sm text-left text-gray-500">
                                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                            <tr>
                                                <th class="px-2 py-2 text-center w-12">Pos</th>
                                                <th class="px-2 py-2">Marca/Modelo</th>
                                                <th class="px-2 py-2 text-center w-20">PSI</th>
                                                <th class="px-2 py-2 text-center w-20">Sulco</th>
                                                <th class="px-2 py-2 text-center w-24">Condição</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${v.tires.map((tire, tIndex) => {
                                                if (tire.pos.includes('E')) return '';
                                                const currentBrandOptions = tireBrands.map(b => `<option value="${b.value}" ${tire.brand === b.value ? 'selected' : ''}>${b.label}</option>`).join('');
                                                return `
                                                <tr class="border-b hover:bg-gray-50">
                                                    <td class="px-2 py-2 font-bold text-gray-800 text-center">${tire.pos}</td>
                                                    <td class="px-2 py-2">
                                                        <select onchange="updateTire(${vIndex}, ${tIndex}, 'brand', this.value)" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:border-azul-02 bg-white">
                                                            <option value="">Selecione...</option>
                                                            ${currentBrandOptions}
                                                        </select>
                                                    </td>
                                                    <td class="px-2 py-2">
                                                        <input type="number" value="${tire.psi}" onchange="updateTire(${vIndex}, ${tIndex}, 'psi', this.value)" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:border-azul-02 text-center" placeholder="PSI">
                                                    </td>
                                                    <td class="px-2 py-2">
                                                        <input type="number" step="0.1" value="${tire.mm}" onchange="updateTire(${vIndex}, ${tIndex}, 'mm', this.value)" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:border-azul-02 text-center" placeholder="mm">
                                                    </td>
                                                    <td class="px-2 py-2">
                                                        <div class="flex space-x-1 justify-center">
                                                            <label class="inline-flex items-center cursor-pointer" title="Ok">
                                                                <input type="radio" name="status-${v.id}-${tIndex}" value="ok" ${tire.status === 'ok' ? 'checked' : ''} onchange="updateTire(${vIndex}, ${tIndex}, 'status', 'ok')" class="sr-only peer">
                                                                <div class="w-6 h-6 rounded-full bg-gray-100 peer-checked:bg-green-500 hover:bg-green-200 flex items-center justify-center transition-colors text-gray-400 peer-checked:text-white">
                                                                    <i class="fa-solid fa-check text-[10px]"></i>
                                                                </div>
                                                            </label>
                                                            <label class="inline-flex items-center cursor-pointer" title="Atenção">
                                                                <input type="radio" name="status-${v.id}-${tIndex}" value="attention" ${tire.status === 'attention' ? 'checked' : ''} onchange="updateTire(${vIndex}, ${tIndex}, 'status', 'attention')" class="sr-only peer">
                                                                <div class="w-6 h-6 rounded-full bg-gray-100 peer-checked:bg-yellow-400 hover:bg-yellow-200 flex items-center justify-center transition-colors text-gray-400 peer-checked:text-white">
                                                                    <i class="fa-solid fa-exclamation text-[10px]"></i>
                                                                </div>
                                                            </label>
                                                            <label class="inline-flex items-center cursor-pointer" title="Troca">
                                                                <input type="radio" name="status-${v.id}-${tIndex}" value="remove" ${tire.status === 'remove' ? 'checked' : ''} onchange="updateTire(${vIndex}, ${tIndex}, 'status', 'remove')" class="sr-only peer">
                                                                <div class="w-6 h-6 rounded-full bg-gray-100 peer-checked:bg-red-500 hover:bg-red-200 flex items-center justify-center transition-colors text-gray-400 peer-checked:text-white">
                                                                    <i class="fa-solid fa-xmark text-[10px]"></i>
                                                                </div>
                                                            </label>
                                                        </div>
                                                    </td>
                                                </tr>`;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-100">
                             <label class="block text-sm font-medium text-gray-700 mb-2">Observações / Recomendações do Veículo</label>
                             <textarea class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-azul-02 text-sm" rows="2" placeholder="Ex: Realizar rodízio dos pneus dianteiros..."></textarea>
                        </div>
                    </div>
                </div>
            `;

                card.innerHTML = headerHtml + bodyHtml;
                container.appendChild(card);
            });
        }

        function toggleDetails(id) {
            const details = document.getElementById(`details-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            details.classList.toggle('hidden');
            if (details.classList.contains('hidden')) {
                icon.style.transform = 'rotate(0deg)';
            } else {
                icon.style.transform = 'rotate(180deg)';
            }
        }

        function updateTire(vIndex, tIndex, field, value) {
            vehiclesData[vIndex].tires[tIndex][field] = value;
            console.log(`Updated Vehicle ${vIndex} Tire ${tIndex}: ${field} = ${value}`);
            persistVehiclesData();
        }

        let activeTire = { vIndex: null, tIndex: null };

        async function connectPrologMock() {
            const btn = document.getElementById('prolog-connect-btn');
            const input = document.getElementById('tire-modal-psi');
            const pill = document.getElementById('prolog-conn-pill');
            if (!btn || !input || !pill) return;

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Conectando...';
            pill.textContent = 'Conectando...';
            pill.className = 'px-2 py-0.5 rounded-full text-[11px] font-extrabold border border-yellow-300 bg-yellow-100 text-yellow-800';

            const delayMs = 1200 + Math.floor(Math.random() * 500);
            await new Promise(resolve => setTimeout(resolve, delayMs));

            const connected = Math.random() > 0.2;
            if (connected) {
                const psi = 90 + Math.floor(Math.random() * 31);
                input.value = String(psi);
                pill.textContent = 'Conectado';
                pill.className = 'px-2 py-0.5 rounded-full text-[11px] font-extrabold border border-green-700 bg-green-600 text-white';
            } else {
                pill.textContent = 'Sem conexão';
                pill.className = 'px-2 py-0.5 rounded-full text-[11px] font-extrabold border border-red-700 bg-red-600 text-white';
            }

            if (activeTire.vIndex !== null && activeTire.tIndex !== null) {
                vehiclesData[activeTire.vIndex].tires[activeTire.tIndex].prologConnected = connected;
            }
            persistVehiclesData();

            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-plug"></i> Conectar Aferidor';
        }

        function openTireModal(vIndex, tIndex) {
            activeTire = { vIndex, tIndex };
            const v = vehiclesData[vIndex];
            const tire = v.tires[tIndex];

            document.getElementById('tire-modal-subtitle').textContent = `${v.placa} • ${v.modelo || ''}`.trim();
            document.getElementById('tire-modal-title').textContent = `Pneu ${tire.pos}`;

            const brandSelect = document.getElementById('tire-modal-brand');
            brandSelect.innerHTML = `<option value="">Selecione...</option>` + tireBrands.map(b => `<option value="${b.value}">${b.label}</option>`).join('');
            brandSelect.value = tire.brand || '';

            document.getElementById('tire-modal-psi').value = tire.psi || '';
            document.getElementById('tire-modal-mm').value = tire.mm || '';
            document.getElementById('tire-modal-obs').value = tire.obs || '';

            const status = tire.status || 'ok';
            const statusInput = document.querySelector(`input[name="tire-modal-status"][value="${status}"]`);
            if (statusInput) statusInput.checked = true;

            const connectBtn = document.getElementById('prolog-connect-btn');
            const pill = document.getElementById('prolog-conn-pill');
            if (connectBtn) {
                connectBtn.disabled = false;
                connectBtn.innerHTML = '<i class="fa-solid fa-plug"></i> Conectar Aferidor';
            }
            if (pill) {
                if (tire.prologConnected) {
                    pill.textContent = 'Conectado';
                    pill.className = 'px-2 py-0.5 rounded-full text-[11px] font-extrabold border border-green-700 bg-green-600 text-white';
                } else {
                    pill.textContent = 'Sem conexão';
                    pill.className = 'px-2 py-0.5 rounded-full text-[11px] font-extrabold border border-gray-200 bg-gray-100 text-gray-700';
                }
            }

            document.getElementById('tire-detail-modal').classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        function closeTireModal() {
            document.getElementById('tire-detail-modal').classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            activeTire = { vIndex: null, tIndex: null };
        }

        function saveTireModal() {
            if (activeTire.vIndex === null || activeTire.tIndex === null) return;

            const vIndex = activeTire.vIndex;
            const tIndex = activeTire.tIndex;
            const tire = vehiclesData[vIndex].tires[tIndex];

            tire.brand = document.getElementById('tire-modal-brand').value;
            tire.psi = document.getElementById('tire-modal-psi').value;
            tire.mm = document.getElementById('tire-modal-mm').value;
            tire.obs = document.getElementById('tire-modal-obs').value;

            const statusInput = document.querySelector('input[name="tire-modal-status"]:checked');
            tire.status = statusInput ? statusInput.value : 'ok';

            persistVehiclesData();
            renderVehicles(vehiclesData[vIndex].id);
            closeTireModal();
            showToast('Pneu atualizado', 'success');
        }

        let vehicleIdToDelete = null;

        function openDeleteModal(id) {
            vehicleIdToDelete = id;
            document.getElementById('delete-confirmation-modal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            vehicleIdToDelete = null;
            document.getElementById('delete-confirmation-modal').classList.add('hidden');
        }

        function confirmDeleteVehicle() {
            if (vehicleIdToDelete !== null) {
                vehiclesData = vehiclesData.filter(v => v.id !== vehicleIdToDelete);
                persistVehiclesData();
                renderVehicles();
                showToast('Veículo apagado', 'warning');
                closeDeleteModal();
            }
        }

        function removeVehicle(id) {
            openDeleteModal(id);
        }

        function applyBrandToAll(vIndex, brand) {
            if (!brand) return;
            vehiclesData[vIndex].tires.forEach(t => t.brand = brand);
            persistVehiclesData();
            renderVehicles(vehiclesData[vIndex].id);
            showToast('Marca aplicada a todos os pneus', 'info');
        }

        function viewResult() {
            finishInspection();
        }

        function saveAnalysis() {
            showToast('Aferição salva com sucesso', 'success');
        }

        function finishInspection() {
            // Hide vehicle list and header
            document.getElementById('vehicles-list').classList.add('hidden');
            const header = document.getElementById('inspection-header');
            if(header) header.classList.add('hidden');
            
            // Show results
            const results = document.getElementById('inspection-results');
            results.classList.remove('hidden');
            
            showToast('Aferição concluída - Exibindo resultados', 'success');
            
            // Render charts
            renderCharts();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderCharts() {
            if (typeof Plotly === 'undefined') return;

            const chartLayout = {
                margin: { t: 20, r: 20, b: 40, l: 50 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                showlegend: false,
                font: { family: 'Inter, sans-serif' }
            };
            const config = {responsive: true, displayModeBar: false, displaylogo: false};

            // Chart Position (Sulco)
            const lifeExpectancyData = [{ 
                y: [63, 3, 0], 
                x: ['Em condição de uso', 'Requer atenção', 'Remover pneu'], 
                type: 'bar',
                marker: { color: ['#10B981', '#FBBF24', '#EF4444'] }
            }];
            Plotly.newPlot('chart-position', lifeExpectancyData, { ...chartLayout, yaxis: {title: 'Qtde Pneus'} }, config);

            // Chart Pressure
            const pressureData = [{
                values: [12, 26, 28], 
                labels: ['Pressão Correta', 'Pressão Alta', 'Pressão Baixa'],
                type: 'pie',
                textinfo: 'label+percent',
                marker: { colors: ['#2D44BD', '#4B63D1', '#6699FF'] }
            }];
            Plotly.newPlot('chart-pressure', pressureData, { ...chartLayout, showlegend: true, margin: { t: 20, r: 20, b: 20, l: 20 } }, config);

            // Chart Trend
            const inspections = ['Jul/25', 'Ago/25', 'Set/25', 'Out/25', 'Nov/25', 'Dez/25'];
            const traceCorrect = { x: inspections, y: [10, 15, 12, 18, 14, 12], name: 'Correta', type: 'scatter', mode: 'lines+markers', line: { color: '#10B981', width: 3 }, marker: { size: 8 } };
            const traceLow = { x: inspections, y: [30, 25, 28, 22, 25, 28], name: 'Baixa', type: 'scatter', mode: 'lines+markers', line: { color: '#EF4444', width: 3 }, marker: { size: 8 } };
            const traceHigh = { x: inspections, y: [26, 26, 26, 26, 27, 26], name: 'Alta', type: 'scatter', mode: 'lines+markers', line: { color: '#FBBF24', width: 3 }, marker: { size: 8 } };
            
            const trendLayout = { ...chartLayout, xaxis: { title: 'Mês da Aferição' }, yaxis: { title: 'Quantidade de Pneus' }, showlegend: false, hovermode: 'x unified' };
            Plotly.newPlot('chart-trend', [traceCorrect, traceLow, traceHigh], trendLayout, config);
        }

        window.addEventListener('DOMContentLoaded', () => {
            const loaded = loadVehiclesDataFromStorage();
            if (!loaded || vehiclesData.length === 0) {
                const exampleVehicle1 = {
                    id: 1,
                    placa: 'ABC-1234',
                    modelo: 'Volvo FH 540',
                    config: '6x2',
                    km: '450.000',
                    tires: generateTires('6x2'),
                    vehicleSafetyChecklist: createDefaultVehicleSafetyChecklist()
                };
                exampleVehicle1.tires[0].brand = 'michelin';
                exampleVehicle1.tires[0].psi = '110';
                exampleVehicle1.tires[0].mm = '12.5';
                exampleVehicle1.tires[1].brand = 'michelin';
                exampleVehicle1.tires[1].psi = '110';
                exampleVehicle1.tires[1].mm = '12.0';

                vehiclesData.push(exampleVehicle1);
                persistVehiclesData();
            }
            renderVehicles();
        });
        
        function ensureToastContainer() {
            if (!document.getElementById('toast-container')) {
                const c = document.createElement('div');
                c.id = 'toast-container';
                c.className = 'fixed bottom-5 right-5 z-[1000] space-y-4';
                document.body.appendChild(c);
            }
        }
        
        function showToast(message, type = 'info') {
            ensureToastContainer();
            
            const styles = {
                success: {
                    border: 'border-green-500',
                    icon: 'fa-check-circle',
                    iconColor: 'text-green-500'
                },
                error: {
                    border: 'border-red-500',
                    icon: 'fa-times-circle',
                    iconColor: 'text-red-500'
                },
                warning: {
                    border: 'border-yellow-500',
                    icon: 'fa-exclamation-triangle',
                    iconColor: 'text-yellow-500'
                },
                info: {
                    border: 'border-azul-02',
                    icon: 'fa-info-circle',
                    iconColor: 'text-azul-02'
                }
            };

            const style = styles[type] || styles.info;

            const toast = document.createElement('div');
            toast.className = `transform transition-all duration-300 ease-out translate-y-2 opacity-0 bg-white border-l-4 ${style.border} shadow-lg rounded-r-lg pointer-events-auto flex items-center p-4 w-auto min-w-[300px] mb-3`;
            
            toast.innerHTML = `
                <div class="flex-shrink-0">
                    <i class="fa-solid ${style.icon} ${style.iconColor} text-xl"></i>
                </div>
                <div class="ml-3 flex-1">
                    <p class="text-sm font-medium text-gray-900">${message}</p>
                </div>
                <div class="ml-4 flex-shrink-0 flex">
                    <button class="bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500 focus:outline-none" onclick="this.closest('div.transform').remove()">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
            `;

            const container = document.getElementById('toast-container');
            container.appendChild(toast);

            // Animação de entrada
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-2', 'opacity-0');
                toast.classList.add('translate-y-0', 'opacity-100');
            });

            // Auto remoção
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.classList.remove('translate-y-0', 'opacity-100');
                    toast.classList.add('translate-y-2', 'opacity-0');
                    toast.addEventListener('transitionend', () => toast.remove());
                }
            }, 4000);
        }
    </script>
    <script>
        // Tablet-only sidebar (md..lg) state
        const TABLET_MIN_W = 768;

        function isTabletViewport() {
            return window.innerWidth >= TABLET_MIN_W;
        }

        function updateTabletSidebarToggleIcon(isExpanded) {
            const btn = document.getElementById('tablet-sidebar-toggle');
            if (!btn) return;
            const icon = btn.querySelector('i');
            if (!icon) return;
            icon.classList.remove('fa-angles-right', 'fa-angles-left');
            icon.classList.add(isExpanded ? 'fa-angles-left' : 'fa-angles-right');
        }

        function setTabletSidebarExpanded(isExpanded) {
            document.body.classList.toggle('pf-tablet-sidebar-expanded', isExpanded);
            updateTabletSidebarToggleIcon(isExpanded);
        }

        function initTabletSidebar() {
            const tabletToggle = document.getElementById('tablet-sidebar-toggle');
            if (tabletToggle && !tabletToggle.dataset.bound) {
                tabletToggle.dataset.bound = '1';
                tabletToggle.addEventListener('click', () => {
                    if (!isTabletViewport()) return;
                    setTabletSidebarExpanded(!document.body.classList.contains('pf-tablet-sidebar-expanded'));
                });
            }

            if (window.innerWidth >= 768) {
                setTabletSidebarExpanded(false);
            } else {
                document.body.classList.remove('pf-tablet-sidebar-expanded');
            }
        }

        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) {
                setTabletSidebarExpanded(false);
            } else {
                document.body.classList.remove('pf-tablet-sidebar-expanded');
            }
        });

        window.addEventListener('load', initTabletSidebar);

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const isClosed = sidebar.classList.contains('-translate-x-full');

            if (isClosed) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
                setTimeout(() => {
                    overlay.classList.remove('opacity-0');
                }, 10);
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('opacity-0');
                setTimeout(() => {
                    overlay.classList.add('hidden');
                }, 300);
            }
        }

        document.getElementById('sidebar-toggle').addEventListener('click', toggleSidebar);

        window.addEventListener('resize', () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');

            if (window.innerWidth >= 768) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.add('hidden', 'opacity-0');
            } else {
                sidebar.classList.add('-translate-x-full');
            }
        });
    </script>
</body>

</html>
